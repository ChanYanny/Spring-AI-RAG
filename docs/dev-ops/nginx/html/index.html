<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - DeepSeek Ollama</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        marked.setOptions({
            breaks: true,
            gfm: true
        });
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #F9F9F7;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #E7E5E4; border-radius: 20px; }
        /* Markdown 样式 */
        .markdown-body { color: #292524; line-height: 1.7; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 700; margin-top: 1.2em; margin-bottom: 0.6em; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body pre { background: #F5F5F4; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; font-size: 0.9em; }
        .markdown-body code { background-color: #E7E5E4; padding: 0.1em 0.3em; border-radius: 0.25em; font-family: monospace; font-size: 0.9em; }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        /* 打字光标 */
        .cursor-blink {
            display: inline-block; width: 6px; height: 16px; background-color: #44403C;
            margin-left: 2px; animation: blink 1s step-end infinite; vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden text-stone-800">
<!-- 左侧侧边栏 -->
<aside class="w-72 bg-stone-100 border-r border-stone-200 hidden md:flex flex-col h-full shrink-0">
    <div class="p-4 border-b border-stone-200">
        <!-- 新建对话按钮 -->
        <button onclick="startNewChat()" class="w-full text-left px-4 py-3 rounded-xl bg-white border border-stone-200 shadow-sm text-sm font-semibold hover:bg-stone-50 transition mb-2 flex items-center gap-2 group">
	                <span class="text-stone-500 group-hover:text-stone-800 transition">
	                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
	                        <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
	                    </svg>
	                </span>
            新建对话
        </button>
    </div>
    <!-- 快捷问题列表 -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
        <div class="text-xs font-bold text-stone-400 mb-3 px-2 uppercase tracking-wider">常见问题</div>
        <div class="space-y-2">
            <button onclick="sendQuickMessage('请用通俗易懂的话解释什么是量子计算？')" class="w-full text-left px-3 py-3 rounded-lg bg-white border border-stone-200 shadow-sm text-sm text-stone-600 hover:text-stone-900 hover:border-stone-300 transition truncate">
                解释量子计算
            </button>
            <button onclick="sendQuickMessage('帮我写一个 Python 脚本，用于批量重命名文件夹里的文件。')" class="w-full text-left px-3 py-3 rounded-lg bg-white border border-stone-200 shadow-sm text-sm text-stone-600 hover:text-stone-900 hover:border-stone-300 transition truncate">
                写一个 Python 脚本
            </button>
            <button onclick="sendQuickMessage('给我讲一个关于程序员的幽默笑话。')" class="w-full text-left px-3 py-3 rounded-lg bg-white border border-stone-200 shadow-sm text-sm text-stone-600 hover:text-stone-900 hover:border-stone-300 transition truncate">
                讲个笑话
            </button>
            <button onclick="sendQuickMessage('制定一份 3 天的东京旅游攻略。')" class="w-full text-left px-3 py-3 rounded-lg bg-white border border-stone-200 shadow-sm text-sm text-stone-600 hover:text-stone-900 hover:border-stone-300 transition truncate">
                东京旅游攻略
            </button>
            <button onclick="sendQuickMessage('如何优化 SQL 查询性能？')" class="w-full text-left px-3 py-3 rounded-lg bg-white border border-stone-200 shadow-sm text-sm text-stone-600 hover:text-stone-900 hover:border-stone-300 transition truncate">
                优化 SQL 查询
            </button>
        </div>
    </div>
    <div class="p-4 border-t border-stone-200 text-xs text-stone-400 text-center">
        Powered by Spring AI & Ollama
    </div>
</aside>
<!-- 右侧主内容区 -->
<main class="flex-1 flex flex-col h-full relative bg-white">
    <!-- 顶部 Header：模型选择 -->
    <header class="h-14 border-b border-stone-100 flex items-center justify-between px-6 shrink-0 bg-white/90 backdrop-blur-sm z-10">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500" title="服务在线"></div>
            <span class="font-medium text-stone-700">Chat</span>
        </div>
        <!-- 模型选择器 -->
        <div class="flex items-center gap-3">
            <label for="model-select" class="text-xs font-semibold text-stone-400 uppercase">Model</label>
            <div class="relative">
                <select id="model-select" class="appearance-none bg-stone-50 border border-stone-200 text-stone-700 py-1 pl-3 pr-8 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-stone-400 focus:border-stone-400 cursor-pointer hover:bg-stone-100 transition font-medium">
                    <option value="deepseek-r1:1.5b" selected>deepseek-r1:1.5b</option>
                    <option value="llama3:8b">llama3:8b</option>
                    <option value="gemma:2b">gemma:2b</option>
                    <option value="mistral:7b">mistral:7b</option>
                    <option value="qwen:7b">qwen:7b</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-500">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>
    </header>
    <!-- 聊天消息容器 -->
    <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar scroll-smooth p-0">
        <!-- 欢迎屏幕 -->
        <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-stone-400 p-8 text-center">
            <div class="w-12 h-12 bg-stone-100 rounded-full flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-stone-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
            </div>
            <h2 class="text-xl font-medium text-stone-600 mb-2">有什么我可以帮你的吗？</h2>
            <p class="text-sm max-w-md">点击左侧常见问题快速开始，或直接输入。</p>
        </div>
        <!-- 消息动态插入区 -->
    </div>
    <!-- 底部输入区 -->
    <div class="w-full border-t border-stone-100 bg-white p-4 shrink-0">
        <div class="max-w-3xl mx-auto relative">
            <div class="relative flex items-end w-full p-3 bg-stone-50 border border-stone-200 rounded-xl focus-within:ring-2 focus-within:ring-stone-200 focus-within:border-stone-300 transition-all shadow-sm">
	                    <textarea
                                id="user-input"
                                rows="1"
                                class="w-full max-h-48 bg-transparent border-0 focus:ring-0 text-stone-800 placeholder-stone-400 resize-none py-1 text-base leading-relaxed"
                                placeholder="发送消息给 AI..."
                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        ></textarea>
                <button
                        id="send-btn"
                        onclick="handleSend()"
                        class="ml-2 mb-1 p-1.5 rounded-lg bg-stone-800 text-white hover:bg-stone-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </div>
            <div class="text-xs text-stone-400 text-center mt-2">
                AI 内容可能不准确，请核对重要信息。
            </div>
        </div>
    </div>
</main>
<script>
    const API_BASE_URL = 'http://localhost:8081/ollama/ai/generateStream';
    const DEFAULT_MODEL = 'deepseek-r1:1.5b';
    let isGenerating = false;
    let eventSource = null;
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const welcomeScreen = document.getElementById('welcome-screen');
    const modelSelect = document.getElementById('model-select');
    // 监听回车发送
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });
    // 新建对话功能
    function startNewChat() {
        // 1. 停止当前的流
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        isGenerating = false;
        sendBtn.disabled = false;
        // 2. 清空聊天内容（保留 welcome-screen div）
        const messages = chatContainer.querySelectorAll('.chat-message-row');
        messages.forEach(el => el.remove());
        // 3. 显示欢迎页
        welcomeScreen.style.display = 'flex';
        // 4. 清空输入框
        userInput.value = '';
        userInput.style.height = 'auto';
    }
    // 快捷点击功能
    function sendQuickMessage(text) {
        userInput.value = text;
        handleSend();
    }
    function handleSend() {
        const message = userInput.value.trim();
        if (!message || isGenerating) return;
        // 1. UI 状态更新
        isGenerating = true;
        userInput.value = '';
        userInput.style.height = 'auto';
        sendBtn.disabled = true;
        welcomeScreen.style.display = 'none';
        // 2. 渲染用户消息
        appendMessage('user', message);
        // 3. 创建 AI 消息占位符
        const aiMessageId = 'msg-' + Date.now();
        appendMessage('ai', '', aiMessageId, true);
        // 4. 获取当前选中的模型
        const selectedModel = modelSelect.value || DEFAULT_MODEL;
        // 5. 构建请求 URL
        const apiUrl = `${API_BASE_URL}?model=${selectedModel}&message=${encodeURIComponent(message)}`;
        // 6. 建立 EventSource 连接
        connectStream(apiUrl, aiMessageId);
    }
    function connectStream(url, msgId) {
        let fullText = "";
        const msgContentDiv = document.getElementById(msgId).querySelector('.markdown-body');
        try {
            eventSource = new EventSource(url);
            eventSource.onmessage = function(event) {
                const rawdata = event.data;
                // 忽略空行或心跳
                if (!rawdata || !rawdata.trim().startsWith('{')) return;
                try {
                    const json = JSON.parse(rawdata);
                    // 兼容获取 result 对象
                    const result = json.result || (json.results && json.results[0]);
                    if (!result) return;
                    // === 关键修改：从 result.output.text 获取 ===
                    let chunkText = "";
                    if (result && result.output && typeof result.output.text === 'string') {
                        chunkText = result.output.text;
                    }
                    // 如果 text 为空，什么都不做，等待下一个包
                    if (chunkText) {
                        fullText += chunkText;
                        msgContentDiv.innerHTML = marked.parse(fullText);
                        scrollToBottom();
                    }
                    // 检查结束状态
                    const metadata = result.metadata;
                    if (metadata && metadata.finishReason) {
                        if (metadata.finishReason.toLowerCase() === 'stop') {
                            console.log('Stream finished.');
                            closeStream();
                        }
                    }
                } catch (parseError) {
                    console.warn("JSON parse error:", parseError);
                }
            };
            eventSource.onerror = function(err) {
                console.error("SSE Error:", err);
                closeStream();
                if (!fullText) {
                    msgContentDiv.innerHTML = `<span class="text-red-500 text-sm">连接服务端失败，请检查跨域设置或服务是否启动。</span>`;
                }
            };
            eventSource.onopen = function() {
                // 移除加载动画
                const loader = msgContentDiv.parentElement.querySelector('.loading-spinner');
                if (loader) loader.remove();
            };
        } catch (e) {
            console.error("EventSource Init Failed:", e);
            closeStream();
        }
    }
    function closeStream() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        isGenerating = false;
        sendBtn.disabled = false;
        // 移除光标
        const cursors = document.querySelectorAll('.cursor-blink');
        cursors.forEach(c => c.remove());
    }
    /**
     * 添加消息到界面
     */
    function appendMessage(role, text, id = null, isLoading = false) {
        const div = document.createElement('div');
        // 增加 chat-message-row 类，方便新建对话时删除
        div.className = "chat-message-row w-full flex justify-center py-6 border-b border-stone-50/50";
        if (id) div.id = id;
        const innerClass = "w-full max-w-3xl px-4 md:px-6 flex gap-4";
        // 图标定义
        const userIcon = `<div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center shrink-0 mt-1"><span class="text-xs font-bold text-stone-600">U</span></div>`;
        const aiIcon = `<div class="w-8 h-8 rounded-full bg-stone-800 flex items-center justify-center shrink-0 mt-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 14a4 4 0 01-4-4v-4a4 4 0 118 0v4a4 4 0 01-4 4z" /></svg></div>`;
        let contentHtml = '';
        if (role === 'user') {
            div.innerHTML = `
	                    <div class="${innerClass}">
	                        ${userIcon}
	                        <div class="flex-1 pt-1 text-stone-800 leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>
	                    </div>
	                `;
        } else {
            let loader = isLoading ? `<div class="loading-spinner flex items-center gap-1 text-stone-400 text-sm"><span class="w-1.5 h-1.5 bg-stone-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-stone-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span><span class="w-1.5 h-1.5 bg-stone-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span> Thinking</div>` : '';
            let renderText = text ? marked.parse(text) : (isLoading ? '' : '');
            div.innerHTML = `
	                    <div class="${innerClass}">
	                        ${aiIcon}
	                        <div class="flex-1 min-w-0">
	                            ${loader}
	                            <div class="markdown-body text-stone-700 text-base leading-relaxed">${renderText}</div>
	                        </div>
	                    </div>
	                `;
        }
        chatContainer.appendChild(div);
        scrollToBottom();
    }
    function scrollToBottom() {
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
</body>
</html>