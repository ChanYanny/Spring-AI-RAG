<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG 知识库上传</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'claude-bg': '#fcfcf9',
                        'claude-paper': '#ffffff',
                        'claude-border': '#e5e5e5',
                        'claude-text-main': '#333333',
                        'claude-text-sub': '#666666',
                        'claude-accent': '#d97757',
                        'claude-accent-hover': '#c06345',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['"Noto Serif SC"', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #fcfcf9;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #e5e5e5;
            border-radius: 4px;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 2px solid rgba(0,0,0,0.1);
            border-left-color: #333;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-claude-text-main min-h-screen flex flex-col items-center py-12 px-4">
<!-- 主容器 -->
<main class="w-full max-w-2xl bg-claude-paper rounded-2xl shadow-soft border border-claude-border overflow-hidden fade-in">
    <!-- 头部区域 -->
    <header class="px-8 pt-8 pb-4 border-b border-claude-border/50">
        <div class="flex items-center gap-2 mb-2">
            <svg class="w-6 h-6 text-claude-accent" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
            <span class="font-serif font-bold text-xl tracking-tight">RAG 知识库</span>
        </div>
        <p class="text-claude-text-sub text-sm font-medium">
            请上传文档至向量数据库以构建您的专属知识库。
        </p>
    </header>
    <!-- 表单区域 -->
    <div class="p-8 space-y-6">
        <!-- 知识库 Tag 输入 -->
        <div class="space-y-2">
            <label for="tagInput" class="block text-sm font-medium text-claude-text-main">
                知识库标签
            </label>
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                </div>
                <input type="text" id="tagInput"
                       class="w-full pl-10 pr-4 py-3 bg-claude-bg border border-claude-border rounded-xl focus:outline-none focus:ring-2 focus:ring-claude-accent/20 focus:border-claude-accent transition-all placeholder-gray-400 text-sm"
                       placeholder="例如：finance_reports_v1">
            </div>
        </div>
        <!-- 拖拽上传区域 -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-claude-text-main">
                上传文件
            </label>
            <div id="dropZone"
                 class="relative border-2 border-dashed border-claude-border rounded-xl p-8 text-center transition-all duration-200 ease-in-out cursor-pointer bg-claude-bg hover:bg-orange-50/30 hover:border-claude-accent/50 group">
                <input type="file" id="fileInput" multiple
                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                       accept=".md,.txt,.pdf,.sql,.docx,.doc">
                <div class="flex flex-col items-center justify-center space-y-3 pointer-events-none">
                    <div class="p-3 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200">
                        <svg class="w-6 h-6 text-claude-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">点击或拖拽文件至此处上传</p>
                        <p class="text-xs text-gray-500 mt-1">支持 MD, TXT, PDF, SQL, DOCX 等格式</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- 文件列表预览 -->
        <div id="fileListContainer" class="hidden space-y-3">
            <div class="flex items-center justify-between text-xs font-semibold text-gray-500 uppercase tracking-wider">
                <span>待上传文件</span>
                <span id="fileCount">0 个文件</span>
            </div>
            <ul id="fileList" class="space-y-2">
                <!-- JS 动态生成文件项 -->
            </ul>
        </div>
        <!-- 提交按钮 -->
        <button id="uploadBtn"
                class="w-full py-3 px-4 bg-gray-900 hover:bg-black text-white font-medium rounded-xl shadow-lg shadow-gray-200/50 transition-all duration-200 flex items-center justify-center gap-2 opacity-50 cursor-not-allowed" disabled>
            <span id="btnText">开始上传</span>
            <div id="btnSpinner" class="spinner hidden"></div>
        </button>
    </div>
</main>
<!-- 页脚信息 -->
<footer class="mt-8 text-center text-gray-400 text-xs">
    <p>&copy; 2026 RAG Knowledge Base System. Current Date: 2026-01-12</p>
</footer>
<!-- 自定义 Toast 通知容器 -->
<div id="toastContainer" class="fixed bottom-6 right-6 flex flex-col gap-3 pointer-events-none z-50"></div>
<script>
    // DOM 元素引用
    const tagInput = document.getElementById('tagInput');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileListContainer = document.getElementById('fileListContainer');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');
    const uploadBtn = document.getElementById('uploadBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    // 状态管理
    let selectedFiles = [];
    // 工具函数：格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    // 工具函数：获取文件图标
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconClass = "w-5 h-5 text-gray-500 mr-3 flex-shrink-0";
        if (['pdf'].includes(ext)) {
            return `<svg class="${iconClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>`;
        } else if (['doc', 'docx'].includes(ext)) {
            return `<svg class="${iconClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`;
        } else if (['txt', 'md', 'sql'].includes(ext)) {
            return `<svg class="${iconClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>`;
        }
        return `<svg class="${iconClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>`;
    }
    // 渲染文件列表
    function renderFileList() {
        fileList.innerHTML = '';
        if (selectedFiles.length === 0) {
            fileListContainer.classList.add('hidden');
            updateButtonState();
            return;
        }
        fileListContainer.classList.remove('hidden');
        fileCount.textContent = `${selectedFiles.length} 个文件`;
        selectedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg shadow-sm group hover:border-orange-100 transition-colors';
            li.innerHTML = `
	                    <div class="flex items-center overflow-hidden">
	                        ${getFileIcon(file.name)}
	                        <div class="flex flex-col min-w-0">
	                            <span class="text-sm font-medium text-gray-800 truncate" title="${file.name}">${file.name}</span>
	                            <span class="text-xs text-gray-400">${formatFileSize(file.size)}</span>
	                        </div>
	                    </div>
	                    <button onclick="removeFile(${index})" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="移除文件">
	                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
	                    </button>
	                `;
            fileList.appendChild(li);
        });
        updateButtonState();
    }
    // 移除文件
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        renderFileList();
        fileInput.value = '';
    };
    // 更新按钮状态
    function updateButtonState() {
        const tagValid = tagInput.value.trim().length > 0;
        const filesValid = selectedFiles.length > 0;
        if (tagValid && filesValid) {
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            uploadBtn.disabled = true;
            uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    // 处理文件选择
    function handleFiles(files) {
        let addedCount = 0;
        Array.from(files).forEach(file => {
            selectedFiles.push(file);
            addedCount++;
        });
        if (addedCount > 0) {
            renderFileList();
            showToast(`已添加 ${addedCount} 个文件`, 'success');
        }
    }
    // 监听 Input 变化
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
    // 拖拽事件处理
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-claude-accent', 'bg-orange-50/30');
        }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-claude-accent', 'bg-orange-50/30');
        }, false);
    });
    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    });
    // Tag 输入监听
    tagInput.addEventListener('input', updateButtonState);
    // 自定义 Toast 通知
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        let bgClass, iconHtml;
        if (type === 'success') {
            bgClass = 'bg-gray-900 text-white';
            iconHtml = `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        } else if (type === 'error') {
            bgClass = 'bg-red-50 text-red-800 border border-red-100';
            iconHtml = `<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
        } else {
            bgClass = 'bg-white text-gray-800 border border-gray-200 shadow-lg';
            iconHtml = `<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        }
        toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto min-w-[300px] ${bgClass}`;
        toast.innerHTML = `
	                ${iconHtml}
	                <span class="text-sm font-medium">${message}</span>
	            `;
        container.appendChild(toast);
        requestAnimationFrame(() => {
            toast.classList.remove('translate-y-10', 'opacity-0');
        });
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    // 上传逻辑
    uploadBtn.addEventListener('click', async () => {
        const tag = tagInput.value.trim();
        if (!tag || selectedFiles.length === 0) return;
        // UI 进入加载状态
        uploadBtn.disabled = true;
        btnText.textContent = '正在处理...';
        btnSpinner.classList.remove('hidden');
        uploadBtn.classList.add('opacity-80');
        // 构建 FormData
        const formData = new FormData();
        formData.append('tag', tag);
        // 匹配后端 List<MultipartFile> files
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });
        try {
            // --- 核心修改区域 ---
            const response = await fetch('http://localhost:8081/rag/uploadFile', {
                method: 'POST',
                body: formData
                // 注意：不要手动设置 'Content-Type': 'multipart/form-data'，
                // 浏览器会自动设置并加上 boundary 参数。
            });
            // ------------------
            if (!response.ok) {
                throw new Error(`HTTP 错误! 状态码: ${response.status}`);
            }
            const result = await response.json();
            // 根据 Java 后端 Response 类结构判断
            if (result.code === "200") {
                showToast(`${result.info}: ${result.data}`, 'success');
                // 重置表单
                selectedFiles = [];
                tagInput.value = '';
                renderFileList();
            } else {
                showToast(result.info || '上传失败', 'error');
            }
        } catch (error) {
            console.error('Upload error:', error);
            showToast('上传失败: ' + error.message, 'error');
        } finally {
            // 恢复 UI 状态
            uploadBtn.disabled = false;
            btnText.textContent = '开始上传';
            btnSpinner.classList.add('hidden');
            uploadBtn.classList.remove('opacity-80');
            updateButtonState();
        }
    });
</script>
</body>
</html>